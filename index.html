<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Queja | Transporte GDL</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Carga de Leaflet (para el mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Carga de Chart.js (para gráficas) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-light: #14b8a6; /* Teal 500 */
            --primary-dark: #0f766e;  /* Teal 700 */
            --secondary: #f59e0b;     /* Amber 500 */
            --background-start: #f0fdfa; /* Teal 50 */
            --background-end: #ccfbf1;   /* Teal 100 */
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --card-bg: rgba(255, 255, 255, 0.85);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        #app-content {
            background-color: var(--card-bg);
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2.5rem;
            width: 100%;
            max-width: 960px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInApp 0.6s 4.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        
        #welcome-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
            z-index: 9999;
            transition: opacity 0.8s 4s ease-out, transform 0.8s 4s ease-out;
        }
        #welcome-animation.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }
        #welcome-animation .logo-container {
            transform: scale(0);
            opacity: 0;
            animation: popIn 1s cubic-bezier(0.68, -0.6, 0.32, 1.6) 0.2s forwards;
        }
        #welcome-animation .logo-text {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInText 1s 0.8s ease-out forwards;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeInText {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInApp {
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes contentFadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section-animation {
            animation: contentFadeInUp 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        header {
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        .header-content h1 {
            font-size: 2.75rem;
            font-weight: 800;
            color: var(--primary-dark);
            letter-spacing: -0.05em;
        }
        .header-content h1 span {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-light);
        }
        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            color: var(--primary-dark);
            transition: all 0.3s ease;
            background-color: transparent;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: var(--primary-dark);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.3), 0 4px 6px -4px rgba(13, 148, 136, 0.3);
        }
        .tab-button:hover:not(.active) {
            background-color: #ccfbf1;
        }
        
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            border: 1px solid #e2e8f0;
        }
        .rating-star {
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.68, -0.6, 0.32, 1.6), fill 0.2s, stroke 0.2s;
            stroke: var(--secondary);
            stroke-width: 1.5;
            fill: none;
        }
        .rating-star.filled, .rating-star:hover {
            fill: var(--secondary);
            transform: scale(1.2);
        }

        .loader {
            border-top-color: var(--primary-dark);
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        #map {
            height: 60vh;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .leaflet-popup-content h4 {
            font-weight: 700;
            color: var(--primary-dark);
        }

        .ranking-filter-btn, .comment-filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            background-color: #f0fdfa;
            color: var(--primary-dark);
            transition: all 0.2s ease;
            border: 1px solid #a7f3d0;
            cursor: pointer;
        }
        .ranking-filter-btn.active, .comment-filter-btn.active {
            background-color: var(--primary-dark);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ranking-filter-btn:hover:not(.active), .comment-filter-btn:hover:not(.active) {
            background-color: #ccfbf1;
            border-color: #5eead4;
        }

        .bus-routes-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            max-height: 250px;
            overflow-y: auto;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        .bus-routes-list button {
            padding: 0.5rem;
            background-color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #0f766e;
            font-weight: 600;
            border: 1px solid #99f6e4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            width: 100%;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
        .bus-routes-list button:hover {
            background-color: #f0fdfa;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        #route-modal:not(.hidden) #modal-content-box {
            animation: modalIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        .autocomplete-suggestion {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f0fdfa;
        }

        /* Nuevos estilos para inputs */
        input[type="text"], input[type="password"], select, textarea {
            transition: all 0.2s ease;
            background-color: #f8fafc;
        }
        input[type="text"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
            --tw-ring-color: var(--primary-light);
            box-shadow: 0 0 0 2px var(--primary-light);
            background-color: white;
            border-color: var(--primary-light) !important;
        }

    </style>
</head>
<body>
    <div id="welcome-animation">
        <div class="text-center">
            <div class="logo-container inline-block p-4 bg-white/20 backdrop-blur-sm rounded-3xl shadow-lg border border-white/30">
                <div class="p-6 bg-white rounded-2xl shadow-inner">
                    <i data-lucide="bus-front" class="w-24 h-24 text-teal-600"></i>
                </div>
            </div>
            <h1 class="logo-text text-5xl font-bold text-white mt-6" style="text-shadow: 0 2px 4px rgba(0,0,0,0.2);">Mi Queja</h1>
            <p class="logo-text text-xl text-teal-100 font-light" style="text-shadow: 0 1px 3px rgba(0,0,0,0.2);">Tu voz para el transporte en GDL</p>
        </div>
    </div>

    <div id="app-content">
        
        <header class="text-center mb-8">
            <div class="header-content flex justify-center items-center gap-4">
                <div class="p-3 bg-teal-600 rounded-2xl shadow-lg shadow-teal-500/30">
                    <i data-lucide="bus-front" class="w-10 h-10 text-white"></i>
                </div>
                <div class="text-left">
                    <h1>Mi Queja <span>| GDL</span></h1>
                    <p class="text-gray-500 -mt-1">Tu voz para un mejor transporte público.</p>
                </div>
            </div>
            <span id="user-id-display" class="text-xs text-teal-600 mt-4 block font-semibold">Modo de demostración (datos locales).</span>
        </header>

        <nav class="flex flex-wrap justify-center items-center mb-10">
            <button id="tab-sesion" class="tab-button active" onclick="switchTab('sesion')">
                <i data-lucide="user" class="w-5 h-5"></i> Sesión
            </button>
            <button id="tab-home" class="tab-button" onclick="switchTab('home')">
                 <i data-lucide="home" class="w-5 h-5"></i> Inicio
            </button>
            <button id="tab-rate" class="tab-button" onclick="switchTab('rate')">
                 <i data-lucide="star-half" class="w-5 h-5"></i> Calificar
            </button>
            <button id="tab-ranking" class="tab-button" onclick="switchTab('ranking')">
                 <i data-lucide="award" class="w-5 h-5"></i> Ranking
            </button>
            <button id="tab-comments" class="tab-button" onclick="switchTab('comments')">
                 <i data-lucide="message-square-text" class="w-5 h-5"></i> Comentarios
            </button>
            <button id="tab-map" class="tab-button" onclick="switchTab('map')">
                 <i data-lucide="map" class="w-5 h-5"></i> Mapa
            </button>
            <button id="tab-routes" class="tab-button" onclick="switchTab('routes')">
                 <i data-lucide="route" class="w-5 h-5"></i> Rutas
            </button>
            <button id="tab-analytics" class="tab-button" onclick="switchTab('analytics')">
                <i data-lucide="area-chart" class="w-5 h-5"></i> Gráficas
            </button>
        </nav>

        <!-- Área de Sesión -->
        <div id="content-sesion" class="">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-3">
                <i data-lucide="user" class="w-8 h-8 text-gray-500"></i> Iniciar Sesión
            </h2>
            <div id="login-form-container" class="card bg-white max-w-lg mx-auto">
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-6">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="text" id="email" name="email" placeholder="tu@correo.com" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm" value="demo@cugdl.udg.mx">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                        <input type="password" id="password" name="password" placeholder="••••••••" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm" value="user">
                    </div>
                    <button type="submit" id="login-button" class="mt-4 w-full bg-gradient-to-r from-teal-500 to-emerald-600 text-white p-3 rounded-xl font-bold text-lg hover:from-teal-600 hover:to-emerald-700 transition duration-300 shadow-lg shadow-teal-500/30 flex items-center justify-center">
                        <span>Iniciar Sesión</span>
                        <i id="login-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></i>
                    </button>
                    <div id="login-status-message" class="mt-4 text-center font-medium hidden p-3 rounded-lg"></div>
                </form>
                <p class="text-center text-gray-500 text-sm mt-6">
                    ¿No tienes cuenta? <a href="#" class="font-medium text-teal-600 hover:text-teal-700" onclick="toggleRegister(event)">Regístrate</a>
                </p>
            </div>

            <!-- Registration Form (Hidden by default) -->
            <div id="register-form-container" class="card bg-white max-w-lg mx-auto mt-6 hidden">
                 <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Crear Cuenta</h3>
                 <form id="register-form" onsubmit="handleRegister(event)">
                    <div class="mb-6">
                        <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="text" id="register-email" name="register-email" placeholder="tu@correo.com" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                        <input type="password" id="register-password" name="register-password" placeholder="••••••••" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm">
                    </div>
                    <button type="submit" id="register-button" class="mt-4 w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3 rounded-xl font-bold text-lg hover:from-blue-600 hover:to-indigo-700 transition duration-300 shadow-lg shadow-blue-500/30 flex items-center justify-center">
                        <span>Registrarse</span>
                        <i id="register-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></i>
                    </button>
                    <div id="register-status-message" class="mt-4 text-center font-medium hidden p-3 rounded-lg"></div>
                 </form>
                 <p class="text-center text-gray-500 text-sm mt-6">
                    ¿Ya tienes cuenta? <a href="#" class="font-medium text-teal-600 hover:text-teal-700" onclick="toggleRegister(event)">Inicia Sesión</a>
                 </p>
            </div>
        </div>

        <!-- Área de Inicio -->
        <div id="content-home" class="hidden">
             <div class="text-center p-8 bg-gradient-to-br from-teal-50 to-emerald-50 rounded-2xl border border-teal-100">
                 <i data-lucide="sparkles" class="w-12 h-12 text-teal-500 mx-auto mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">¡Bienvenido/a a la comunidad!</h2>
                <p class="text-gray-600 max-w-2xl mx-auto leading-relaxed">
                    Esta es una plataforma ciudadana para compartir y consultar experiencias sobre el transporte público en Guadalajara. Tu opinión es <strong>anónima y ayuda a construir un panorama real y transparente</strong> del servicio.
                </p>
             </div>
             <div class="mt-8">
                <h3 class="text-2xl font-semibold text-gray-700 mb-6 text-center">¿Cómo funciona?</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Item -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                        <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4">
                           <i data-lucide="star-half" class="w-7 h-7"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-1">1. Califica tu Viaje</h4>
                        <p class="text-gray-600 text-sm">Evalúa tu experiencia de forma rápida y anónima.</p>
                    </div>
                    <!-- Item -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                         <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="award" class="w-7 h-7"></i>
                         </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-1">2. Consulta el Ranking</h4>
                        <p class="text-gray-600 text-sm">Descubre las rutas mejor y peor valoradas.</p>
                    </div>
                    <!-- Item -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                         <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="message-square-text" class="w-7 h-7"></i>
                         </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-1">3. Lee Comentarios</h4>
                        <p class="text-gray-600 text-sm">Explora opiniones y sugerencias de otros usuarios.</p>
                    </div>
                     <!-- Item -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                         <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="map" class="w-7 h-7"></i>
                         </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-1">4. Explora el Mapa</h4>
                        <p class="text-gray-600 text-sm">Ubica rutas principales y sus calificaciones.</p>
                    </div>
                    <!-- Item -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                         <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="route" class="w-7 h-7"></i>
                         </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-1">5. Directorio de Rutas</h4>
                        <p class="text-gray-600 text-sm">Accede a un listado organizado de todas las rutas.</p>
                    </div>
                    <!-- Item -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                         <div class="w-12 h-12 bg-sky-100 text-sky-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="area-chart" class="w-7 h-7"></i>
                         </div>
                        <h4 class="font-bold text-lg text-gray-800 mb-1">6. Analiza Gráficas</h4>
                        <p class="text-gray-600 text-sm">Visualiza promedios de calificación por categoría.</p>
                    </div>
                </div>
             </div>
        </div>

        <!-- Área de Calificación -->
        <div id="content-rate" class="card bg-white hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-3"><i data-lucide="clipboard-pen" class="w-8 h-8 text-teal-500"></i> Califica tu Viaje</h2>
            <form id="rating-form" onsubmit="handleRatingSubmit(event)">
                <div class="mb-8 p-6 bg-gray-50 rounded-xl border">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">1. Datos del Viaje</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="transportType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Transporte <span class="text-red-500">*</span></label>
                            <select id="transportType" name="transportType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm">
                                <option value="">Selecciona una opción</option>
                                <option value="tren-l1">Mi Tren - Línea 1</option>
                                <option value="tren-l2">Mi Tren - Línea 2</option>
                                <option value="tren-l3">Mi Tren - Línea 3</option>
                                <option value="macro-calzada">Mi Macro Calzada</option>
                                <option value="macro-periferico">Mi Macro Periférico</option>
                                <option value="bus-t">Mi Transporte (Ruta T - Troncal)</option>
                                <option value="bus-c">Mi Transporte (Ruta C - Complementaria)</option>
                                <option value="bus-a">Mi Transporte (Ruta A - Alimentadora)</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label for="routeLine" class="block text-sm font-medium text-gray-700 mb-1">Ruta/Línea Específica <span class="text-red-500">*</span></label>
                           <input type="text" id="routeLine" name="routeLine" placeholder="Ej: T01, C123" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm" autocomplete="off">
                           <div id="autocomplete-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 hidden max-h-48 overflow-y-auto shadow-lg"></div>
                        </div>
                       <div>
                            <label for="unitNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Unidad (Opcional)</label>
                            <input type="text" id="unitNumber" name="unitNumber" placeholder="Ej: 1054" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm">
                        </div>
                    </div>
                </div>

                <div class="mb-8 p-6 bg-gray-50 rounded-xl border">
                     <h3 class="font-bold text-lg mb-4 text-gray-700">2. Calificación por Aspecto (1-5 Estrellas)</h3>
                    <div id="ratings-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div class="mb-6">
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">3. Comentario Adicional (Opcional)</label>
                    <textarea id="comment" name="comment" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-teal-400 shadow-sm" placeholder="¿Qué tal fue tu viaje? Detalles sobre limpieza, puntualidad, amabilidad del conductor, etc..."></textarea>
                </div>
                <button type="submit" id="submit-button" class="mt-4 w-full bg-gradient-to-r from-teal-500 to-emerald-600 text-white p-4 rounded-xl font-bold text-lg hover:from-teal-600 hover:to-emerald-700 transition duration-300 shadow-lg shadow-teal-500/30 flex items-center justify-center disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed" disabled>
                    <span id="submit-text">Completa todos los campos</span>
                    <i id="submit-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></i>
                </button>
                <div id="status-message" class="mt-4 text-center font-medium hidden p-3 rounded-lg"></div>
            </form>
        </div>

        <!-- Área de Ranking -->
        <div id="content-ranking" class="card bg-white hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-3"><i data-lucide="trophy" class="w-8 h-8 text-yellow-500"></i> Ranking Global de Rutas</h2>
            <div class="flex flex-wrap justify-center gap-2 mb-6 border-b pb-4">
                <button class="ranking-filter-btn active" data-filter="all" onclick="filterAndDisplayRanking('all')">Todos</button>
                <button class="ranking-filter-btn" data-filter="tren" onclick="filterAndDisplayRanking('tren')">Mi Tren</button>
                <button class="ranking-filter-btn" data-filter="macro" onclick="filterAndDisplayRanking('macro')">Mi Macro</button>
                <button class="ranking-filter-btn" data-filter="bus-t" onclick="filterAndDisplayRanking('bus-t')">Rutas T</button>
                <button class="ranking-filter-btn" data-filter="bus-c" onclick="filterAndDisplayRanking('bus-c')">Rutas C</button>
                <button class="ranking-filter-btn" data-filter="bus-a" onclick="filterAndDisplayRanking('bus-a')">Rutas A</button>
            </div>
            <div id="ranking-container" class="space-y-4">
                <p class="text-center text-gray-500 p-4">Cargando ranking comunitario...</p>
            </div>
        </div>

        <!-- Área de Comentarios -->
        <div id="content-comments" class="card bg-white hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-3"><i data-lucide="messages-square" class="w-8 h-8 text-blue-500"></i> Comentarios de la Comunidad</h2>
            
            <div class="flex flex-wrap justify-center gap-2 mb-6 border-b pb-4">
                <button class="comment-filter-btn active" data-filter="all" onclick="filterAndDisplayComments('all')">Todos</button>
                <button class="comment-filter-btn" data-filter="tren" onclick="filterAndDisplayComments('tren')">Mi Tren</button>
                <button class="comment-filter-btn" data-filter="macro" onclick="filterAndDisplayComments('macro')">Mi Macro</button>
                <button class="comment-filter-btn" data-filter="bus-t" onclick="filterAndDisplayComments('bus-t')">Rutas T</button>
                <button class="comment-filter-btn" data-filter="bus-c" onclick="filterAndDisplayComments('bus-c')">Rutas C</button>
                <button class="comment-filter-btn" data-filter="bus-a" onclick="filterAndDisplayComments('bus-a')">Rutas A</button>
            </div>

            <div id="comments-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <p class="text-center text-gray-500 p-4">Cargando comentarios...</p>
            </div>
        </div>
        
        <!-- Área de Mapa -->
        <div id="content-map" class="hidden">
             <h2 class="text-3xl font-bold text-gray-800 mb-4 flex items-center gap-3"><i data-lucide="map" class="w-8 h-8 text-red-500"></i> Mapa de Rutas Principales</h2>
             <p class="text-gray-600 mb-6">
                Visualiza las rutas de Mi Tren y Mi Macro. Haz clic en una ruta para ver su información y calificación promedio.
             </p>
            <div id="map"></div>
        </div>
        
        <!-- Área de Rutas -->
        <div id="content-routes" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-3"><i data-lucide="library" class="w-8 h-8 text-purple-500"></i> Directorio de Rutas</h2>
            <div class="space-y-8">
                <!-- Mi Tren -->
                <div class="flex flex-col md:flex-row items-center gap-6 p-6 bg-gray-50 rounded-2xl border-l-8 border-red-500">
                    <img src="https://placehold.co/200x150/ef4444/ffffff?text=Mi+Tren&font=poppins" alt="Mi Tren" class="w-full md:w-48 h-full object-cover rounded-lg shadow-md">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="train-front" class="w-7 h-7 mr-2 text-red-600"></i> Mi Tren</h3>
                        <p class="text-gray-600 mb-3">El sistema de tren ligero eléctrico que conecta puntos clave de la ciudad de forma rápida y eficiente.</p>
                        <ul class="space-y-1 text-sm text-gray-700 font-medium list-disc list-inside">
                            <li><span class="font-semibold text-red-600">Línea 1:</span> Periférico Norte - Sur</li>
                            <li><span class="font-semibold text-green-600">Línea 2:</span> Juárez - Tetlán</li>
                            <li><span class="font-semibold text-fuchsia-600">Línea 3:</span> Arcos de Zapopan - Central de Autobuses</li>
                        </ul>
                    </div>
                </div>
                <!-- Mi Macro -->
                <div class="flex flex-col md:flex-row items-center gap-6 p-6 bg-gray-50 rounded-2xl border-l-8 border-blue-500">
                    <img src="https://placehold.co/200x150/3b82f6/ffffff?text=Mi+Macro&font=poppins" alt="Mi Macro" class="w-full md:w-48 h-full object-cover rounded-lg shadow-md">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bus-front" class="w-7 h-7 mr-2 text-blue-600"></i> Mi Macro</h3>
                        <p class="text-gray-600 mb-3">Sistema de autobús de tránsito rápido (BRT) con carriles exclusivos para mayor velocidad y capacidad.</p>
                        <ul class="space-y-1 text-sm text-gray-700 font-medium list-disc list-inside">
                            <li><span class="font-semibold text-blue-600">Macro Calzada:</span> Calzada Independencia</li>
                            <li><span class="font-semibold text-purple-600">Macro Periférico:</span> Circuito Periférico</li>
                        </ul>
                    </div>
                </div>
                <!-- Mi Transporte (Autobuses) -->
                <div class="flex flex-col md:flex-row items-center gap-6 p-6 bg-gray-50 rounded-2xl border-l-8 border-green-500">
                    <img src="https://placehold.co/200x150/22c55e/ffffff?text=Mi+Transporte&font=poppins" alt="Mi Transporte" class="w-full md:w-48 h-full object-cover rounded-lg shadow-md">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bus" class="w-7 h-7 mr-2 text-green-600"></i> Mi Transporte (Rutas)</h3>
                        <p class="text-gray-600 mb-3">La red de autobuses urbanos que cubre la mayor parte del área metropolitana.</p>
                        <ul class="space-y-1 text-sm text-gray-700 font-medium list-disc list-inside">
                            <li><span class="font-semibold text-gray-700">Rutas T (Troncales):</span> Ejes viales principales.</li>
                            <li><span class="font-semibold text-gray-700">Rutas C (Complementarias):</span> Conectan colonias y barrios.</li>
                            <li><span class="font-semibold text-gray-700">Rutas A (Alimentadoras):</span> Conectan con Mi Tren y Mi Macro.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Gráficas -->
        <div id="content-analytics" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4 flex items-center gap-3"><i data-lucide="bar-chart-3" class="w-8 h-8 text-sky-500"></i> Analíticas Comunitarias</h2>
             <p class="text-gray-600 mb-6 text-center">
                Visualiza el promedio de calificaciones en aspectos clave, basado en todas las opiniones de los usuarios.
             </p>
            <div class="card bg-white">
                <canvas id="ratingsChart"></canvas>
            </div>
        </div>

    </div> <!-- Fin de #app-content -->

    <!--
    /////////////////////////////////////////////////////////////////////
    // INICIO DEL CÓDIGO JAVASCRIPT
    // Todo el "motor" de la aplicación está aquí.
    /////////////////////////////////////////////////////////////////////
    -->
    <script>
        // Variables globales
        let currentTab = 'sesion';
        let leafletMap;
        let ratingsChart;
        let selectedRatings = {}; // Almacena las estrellas seleccionadas
        const ratingCategories = [
            { id: 'limpieza', name: 'Limpieza de la Unidad' },
            { id: 'puntualidad', name: 'Puntualidad / Frecuencia' },
            { id: 'conduccion', name: 'Calidad de Conducción' },
            { id: 'amabilidad', name: 'Amabilidad del Conductor' },
            { id: 'seguridad', name: 'Seguridad en el Viaje' },
            { id: 'espacio', name: 'Espacio / Ocupación' }
        ];

        // --- DATOS DE DEMOSTRACIÓN ---
        // Lista de rutas para autocompletar
        const allRoutes = [
            'Línea 1', 'Línea 2', 'Línea 3', 'Macro Calzada', 'Macro Periférico',
            'T01', 'T02', 'T03', 'T04A', 'T04B', 'T05', 'T06', 'T07', 'T08', 'T09', 'T10',
            'C01', 'C02', 'C03', 'C04', 'C05', 'C06', 'C07', 'C08', 'C09', 'C10',
            'C11', 'C12', 'C13', 'C14', 'C15', 'C16', 'C17', 'C18', 'C19', 'C20',
            'C123', 'C124', 'C125', 'C126', 'C127', 'C128', 'C129', 'C130',
            'A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07'
        ];

        // Datos de demo para el Ranking
        const demoRankingData = [
            { id: 'tren-l3', route: 'Mi Tren - Línea 3', type: 'tren', rating: 4.8, votes: 120 },
            { id: 'macro-peri', route: 'Mi Macro Periférico', type: 'macro', rating: 4.5, votes: 95 },
            { id: 'tren-l1', route: 'Mi Tren - Línea 1', type: 'tren', rating: 4.2, votes: 150 },
            { id: 'bus-t02', route: 'T02', type: 'bus-t', rating: 3.9, votes: 88 },
            { id: 'bus-c123', route: 'C123', type: 'bus-c', rating: 3.5, votes: 45 },
            { id: 'macro-calzada', route: 'Mi Macro Calzada', type: 'macro', rating: 3.2, votes: 210 },
            { id: 'bus-c01', route: 'C01', type: 'bus-c', rating: 2.8, votes: 76 },
            { id: 'bus-t04a', route: 'T04A', type: 'bus-t', rating: 2.5, votes: 132 },
            { id: 'bus-a06', route: 'A06', type: 'bus-a', rating: 2.2, votes: 30 },
            { id: 'tren-l2', route: 'Mi Tren - Línea 2', type: 'tren', rating: 2.1, votes: 190 }
        ];

        // Datos de demo para Comentarios
        const demoCommentsData = [
            { id: '1', route: 'Mi Tren - Línea 3', type: 'tren', rating: 5, comment: 'Súper limpia y rápida. Siempre la uso para ir a Zapopan y es una maravilla.', time: 'hace 2 horas' },
            { id: '2', route: 'T04A', type: 'bus-t', rating: 2, comment: 'El conductor manejaba como loco, frenando y acelerando. Además, la unidad venía muy sucia.', time: 'hace 5 horas' },
            { id: '3', route: 'Mi Macro Calzada', type: 'macro', rating: 3, comment: 'Muy lento hoy, tardó más de 20 minutos en pasar y venía llenísimo. Imposible subirse.', time: 'hace 1 día' },
            { id: '4', route: 'C123', type: 'bus-c', rating: 4, comment: 'Unidad nueva y con aire acondicionado. El conductor fue muy amable.', time: 'hace 2 días' },
            { id: '5', route: 'Mi Macro Periférico', type: 'macro', rating: 5, comment: 'La mejor inversión que han hecho. Me ahorra 30 minutos diarios.', time: 'hace 2 días' }
        ];

        // --- INICIALIZACIÓN DE LA APP ---
        document.addEventListener('DOMContentLoaded', () => {
            // Reemplazar todos los íconos de Lucide
            lucide.createIcons();

            // Ocultar la animación de bienvenida después del tiempo
            setTimeout(() => {
                document.getElementById('welcome-animation').classList.add('hidden');
            }, 4400); // Un poco antes de que la app aparezca

            // Inicializar la pestaña por defecto (Sesión)
            switchTab(currentTab);

            // Generar los campos de calificación
            generateRatingFields();

            // Configurar listeners para el formulario de calificación
            setupRatingFormListeners();

            // Configurar listeners para el autocompletado
            setupAutocomplete();
        });

        // --- LÓGICA DE NAVEGACIÓN (PESTAÑAS) ---
        function switchTab(tabId) {
            // Ocultar contenido actual
            const currentContent = document.getElementById(`content-${currentTab}`);
            if (currentContent) {
                currentContent.classList.add('hidden');
            }
            // Quitar 'active' del botón actual
            const currentButton = document.getElementById(`tab-${currentTab}`);
            if (currentButton) {
                currentButton.classList.remove('active');
            }

            // Mostrar nuevo contenido
            const newContent = document.getElementById(`content-${tabId}`);
            if (newContent) {
                newContent.classList.remove('hidden');
                newContent.classList.add('section-animation');
            }
            // Poner 'active' en el nuevo botón
            const newButton = document.getElementById(`tab-${tabId}`);
            if (newButton) {
                newButton.classList.add('active');
            }

            // Actualizar pestaña actual
            currentTab = tabId;

            // Lógica específica al abrir una pestaña
            if (tabId === 'map') {
                initMap();
            } else if (tabId === 'analytics') {
                initAnalytics();
            } else if (tabId === 'ranking') {
                filterAndDisplayRanking('all'); // Mostrar todos por defecto
            } else if (tabId === 'comments') {
                filterAndDisplayComments('all'); // Mostrar todos por defecto
            }
        }

        // --- LÓGICA DE SESIÓN Y REGISTRO ---
        function toggleRegister(e) {
            e.preventDefault();
            const loginForm = document.getElementById('login-form-container');
            const registerForm = document.getElementById('register-form-container');
            
            // Limpiar mensajes de estado
            document.getElementById('login-status-message').classList.add('hidden');
            document.getElementById('register-status-message').classList.add('hidden');

            if (registerForm.classList.contains('hidden')) {
                // Mostrar registro, ocultar login
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerForm.classList.add('section-animation');
            } else {
                // Mostrar login, ocultar registro
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                loginForm.classList.add('section-animation');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const button = document.getElementById('login-button');
            const spinner = document.getElementById('login-spinner');
            const statusMessage = document.getElementById('login-status-message');

            // Simular carga
            button.disabled = true;
            spinner.classList.remove('hidden');
            statusMessage.classList.add('hidden');

            setTimeout(() => {
                // Simulación de éxito
                button.disabled = false;
                spinner.classList.add('hidden');
                
                statusMessage.innerText = '¡Inicio de sesión exitoso! Redirigiendo...';
                statusMessage.classList.remove('hidden', 'text-red-600', 'bg-red-100');
                statusMessage.classList.add('text-green-600', 'bg-green-100');

                document.getElementById('user-id-display').innerText = `Usuario: ${email}`;

                // Redirigir a la pestaña "Home"
                setTimeout(() => {
                    switchTab('home');
                    statusMessage.classList.add('hidden');
                    document.getElementById('login-form').reset();
                }, 1500);

            }, 2000);
        }

        function handleRegister(e) {
            e.preventDefault();
            const button = document.getElementById('register-button');
            const spinner = document.getElementById('register-spinner');
            const statusMessage = document.getElementById('register-status-message');

            // Simular carga
            button.disabled = true;
            spinner.classList.remove('hidden');
            statusMessage.classList.add('hidden');

            setTimeout(() => {
                // Simulación de éxito
                button.disabled = false;
                spinner.classList.add('hidden');
                
                statusMessage.innerText = '¡Registro exitoso! Ahora puedes iniciar sesión.';
                statusMessage.classList.remove('hidden', 'text-red-600', 'bg-red-100');
                statusMessage.classList.add('text-green-600', 'bg-green-100');

                // Volver al login
                setTimeout(() => {
                    toggleRegister(e); // Llama a toggleRegister para volver al login
                    document.getElementById('register-form').reset();
                }, 2000);

            }, 2000);
        }


        // --- LÓGICA DE CALIFICACIÓN ---
        function generateRatingFields() {
            const container = document.getElementById('ratings-container');
            container.innerHTML = '';
            
            ratingCategories.forEach(category => {
                selectedRatings[category.id] = 0; // Inicializar en 0

                const fieldHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 bg-white rounded-lg shadow-sm border">
                        <span class="text-sm font-medium text-gray-700 mb-2 sm:mb-0">${category.name}</span>
                        <div class="flex items-center gap-1" data-category="${category.id}">
                            ${[1, 2, 3, 4, 5].map(star => `
                                <svg class="w-7 h-7 rating-star" data-value="${star}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += fieldHTML;
            });

            // Añadir eventos a las estrellas
            container.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', handleStarClick);
                star.addEventListener('mouseover', handleStarHover);
                star.addEventListener('mouseout', handleStarOut);
            });
        }

        function handleStarClick(e) {
            const star = e.currentTarget;
            const category = star.parentElement.dataset.category;
            const value = parseInt(star.dataset.value);
            
            selectedRatings[category] = value;
            updateStars(category, value);
            validateForm(); // Validar el formulario después de cada clic
        }

        function handleStarHover(e) {
            const star = e.currentTarget;
            const category = star.parentElement.dataset.category;
            const value = parseInt(star.dataset.value);
            updateStars(category, value, true); // Hover state
        }

        function handleStarOut(e) {
            const star = e.currentTarget;
            const category = star.parentElement.dataset.category;
            const savedValue = selectedRatings[category];
            updateStars(category, savedValue); // Reset to saved state
        }

        function updateStars(category, value, isHovering = false) {
            const stars = document.querySelectorAll(`#ratings-container [data-category="${category}"] .rating-star`);
            stars.forEach(star => {
                const starValue = parseInt(star.dataset.value);
                if (starValue <= value) {
                    star.classList.add('filled');
                    if (isHovering) {
                        star.style.fill = 'var(--secondary)'; // Ensure hover fill
                    }
                } else {
                    star.classList.remove('filled');
                    star.style.fill = 'none'; // Ensure no fill
                }
            });
        }

        function setupRatingFormListeners() {
            const form = document.getElementById('rating-form');
            const requiredInputs = form.querySelectorAll('[required]');
            
            requiredInputs.forEach(input => {
                input.addEventListener('input', validateForm);
            });
        }

        function validateForm() {
            const form = document.getElementById('rating-form');
            const submitButton = document.getElementById('submit-button');
            const submitText = document.getElementById('submit-text');

            // 1. Validar inputs requeridos (transporte y ruta)
            const transportType = document.getElementById('transportType').value;
            const routeLine = document.getElementById('routeLine').value;
            const inputsValid = transportType !== "" && routeLine !== "";

            // 2. Validar que todas las categorías de estrellas tengan al menos 1
            let allStarsRated = true;
            for (const category in selectedRatings) {
                if (selectedRatings[category] === 0) {
                    allStarsRated = false;
                    break;
                }
            }

            // 3. Habilitar o deshabilitar el botón
            if (inputsValid && allStarsRated) {
                submitButton.disabled = false;
                submitText.innerText = 'Enviar Calificación';
            } else {
                submitButton.disabled = true;
                if (!inputsValid) {
                    submitText.innerText = 'Completa los datos del viaje';
                } else if (!allStarsRated) {
                    submitText.innerText = 'Califica todos los aspectos';
                }
            }
        }

        function handleRatingSubmit(e) {
            e.preventDefault();
            const button = document.getElementById('submit-button');
            const spinner = document.getElementById('submit-spinner');
            const statusMessage = document.getElementById('status-message');
            const form = document.getElementById('rating-form');

            // Simular carga
            button.disabled = true;
            spinner.classList.remove('hidden');
            statusMessage.classList.add('hidden');

            setTimeout(() => {
                // Simulación de éxito
                button.disabled = false;
                spinner.classList.add('hidden');
                
                statusMessage.innerText = '¡Calificación enviada con éxito! Gracias por tu opinión.';
                statusMessage.classList.remove('hidden', 'text-red-600', 'bg-red-100');
                statusMessage.classList.add('text-green-600', 'bg-green-100');

                // Resetear formulario
                form.reset();
                selectedRatings = {}; // Limpiar objeto de ratings
                generateRatingFields(); // Regenerar estrellas
                validateForm(); // Resetear estado del botón

                // Ocultar mensaje después de 3 segundos
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);

            }, 2000);
        }

        // --- LÓGICA DE AUTOCOMPLETADO ---
        function setupAutocomplete() {
            const input = document.getElementById('routeLine');
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');

            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                if (query.length < 1) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                const filteredRoutes = allRoutes.filter(route => 
                    route.toLowerCase().includes(query)
                );

                if (filteredRoutes.length === 0) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                suggestionsContainer.innerHTML = '';
                filteredRoutes.slice(0, 5).forEach(route => { // Limitar a 5 sugerencias
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.className = 'autocomplete-suggestion';
                    suggestionDiv.innerText = route;
                    suggestionDiv.addEventListener('click', () => {
                        input.value = route;
                        suggestionsContainer.classList.add('hidden');
                        validateForm(); // Validar formulario al seleccionar
                    });
                    suggestionsContainer.appendChild(suggestionDiv);
                });

                suggestionsContainer.classList.remove('hidden');
            });

            // Ocultar sugerencias si se hace clic fuera
            document.addEventListener('click', (e) => {
                if (e.target !== input) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }


        // --- LÓGICA DE RANKING ---
        function filterAndDisplayRanking(filter) {
            // Actualizar botones de filtro
            document.querySelectorAll('.ranking-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });

            const container = document.getElementById('ranking-container');
            container.innerHTML = ''; // Limpiar

            const filteredData = (filter === 'all') 
                ? demoRankingData 
                : demoRankingData.filter(item => item.type === filter || (filter === 'bus-t' && item.type.startsWith('bus-t')) || (filter === 'bus-c' && item.type.startsWith('bus-c')) || (filter === 'bus-a' && item.type.startsWith('bus-a')) || (filter === 'tren' && item.type.startsWith('tren')) || (filter === 'macro' && item.type.startsWith('macro')));
            
            // Ordenar de mejor a peor
            filteredData.sort((a, b) => b.rating - a.rating);

            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para esta categoría.</p>';
                return;
            }

            filteredData.forEach((item, index) => {
                const rank = index + 1;
                const starPercentage = (item.rating / 5) * 100;

                let
                 bgColor, borderColor, textColor;
                if (rank === 1) {
                    bgColor = 'bg-gradient-to-r from-amber-100 to-yellow-50'; borderColor = 'border-yellow-400'; textColor = 'text-yellow-700';
                } else if (rank === 2) {
                    bgColor = 'bg-gradient-to-r from-gray-100 to-slate-50'; borderColor = 'border-gray-300'; textColor = 'text-gray-600';
                } else if (rank === 3) {
                    bgColor = 'bg-gradient-to-r from-orange-100 to-amber-50'; borderColor = 'border-orange-300'; textColor = 'text-orange-700';
                } else if (item.rating < 3) {
                    bgColor = 'bg-red-50'; borderColor = 'border-red-200'; textColor = 'text-red-700';
                } else {
                    bgColor = 'bg-white'; borderColor = 'border-gray-200'; textColor = 'text-gray-800';
                }

                const itemHTML = `
                    <div class="flex items-center gap-4 p-4 ${bgColor} rounded-xl border ${borderColor} shadow-sm">
                        <div class="flex-none w-10 h-10 rounded-full ${bgColor} border ${borderColor} flex items-center justify-center font-bold text-lg ${textColor}">
                            ${rank}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg ${textColor}">${item.route}</h4>
                            <span class="text-sm font-medium text-gray-500">${item.votes} calificaciones</span>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center justify-end gap-1 font-bold text-xl ${textColor}">
                                <i data-lucide="star" class="w-5 h-5 text-yellow-500 fill-current"></i>
                                ${item.rating.toFixed(1)}
                            </div>
                            <!-- Barra de estrellas -->
                            <div class="w-24 h-2 bg-gray-200 rounded-full mt-1 overflow-hidden">
                                <div class="h-full bg-yellow-400" style="width: ${starPercentage}%;"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
            lucide.createIcons(); // Recargar íconos
        }

        // --- LÓGICA DE COMENTARIOS ---
        function filterAndDisplayComments(filter) {
            // Actualizar botones de filtro
            document.querySelectorAll('.comment-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });

            const container = document.getElementById('comments-container');
            container.innerHTML = ''; // Limpiar

            const filteredData = (filter === 'all')
                ? demoCommentsData
                : demoCommentsData.filter(item => item.type === filter || (filter === 'bus-t' && item.type.startsWith('bus-t')) || (filter === 'bus-c' && item.type.startsWith('bus-c')) || (filter === 'bus-a' && item.type.startsWith('bus-a')) || (filter === 'tren' && item.type.startsWith('tren')) || (filter === 'macro' && item.type.startsWith('macro')));
            
            // Ordenar por más reciente (en este demo, por ID)
            filteredData.sort((a, b) => b.id - a.id);

            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 p-4">No hay comentarios para esta categoría.</p>';
                return;
            }

            filteredData.forEach(item => {
                const itemHTML = `
                    <div class="p-5 bg-white rounded-xl border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-teal-700">${item.route}</h4>
                            <span class="text-xs text-gray-400">${item.time}</span>
                        </div>
                        <div class="flex items-center gap-1 mb-3">
                            ${[1, 2, 3, 4, 5].map(star => `
                                <i data-lucide="star" class="w-4 h-4 ${star <= item.rating ? 'text-yellow-500 fill-current' : 'text-gray-300'}"></i>
                            `).join('')}
                        </div>
                        <p class="text-gray-700 leading-relaxed">${item.comment}</p>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
            lucide.createIcons(); // Recargar íconos
        }


        // --- LÓGICA DEL MAPA ---
        function initMap() {
            // Prevenir reinicialización
            if (leafletMap) {
                leafletMap.invalidateSize();
                return;
            }
            
            // Coordenadas de GDL
            const GDL_COORDS = [20.659698, -103.349609];
            leafletMap = L.map('map').setView(GDL_COORDS, 12);

            // Capa de mosaico de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(leafletMap);

            // --- Demo de Rutas (datos ficticios de coordenadas) ---
            // Mi Tren L1 (Rojo)
            const trenL1 = [[20.730, -103.350], [20.715, -103.352], [20.690, -103.348], [20.670, -103.347], [20.650, -103.349], [20.620, -103.351], [20.590, -103.353]];
            L.polyline(trenL1, { color: '#E53E3E', weight: 5 }).addTo(leafletMap)
                .bindPopup('<h4>Mi Tren - Línea 1</h4><p>Calificación: 4.2 / 5</p>');

            // Mi Tren L2 (Verde)
            const trenL2 = [[20.675, -103.380], [20.676, -103.360], [20.675, -103.347], [20.674, -103.320], [20.673, -103.300]];
            L.polyline(trenL2, { color: '#38A169', weight: 5 }).addTo(leafletMap)
                .bindPopup('<h4>Mi Tren - Línea 2</h4><p>Calificación: 2.1 / 5</p>');

            // Mi Tren L3 (Rosa)
            const trenL3 = [[20.720, -103.385], [20.690, -103.370], [20.675, -103.347], [20.660, -103.310], [20.640, -103.290]];
            L.polyline(trenL3, { color: '#D53F8C', weight: 5 }).addTo(leafletMap)
                .bindPopup('<h4>Mi Tren - Línea 3</h4><p>Calificación: 4.8 / 5</p>');

            // Mi Macro Calzada (Azul)
            const macroCalzada = [[20.700, -103.330], [20.680, -103.331], [20.660, -103.330], [20.640, -103.329], [20.620, -103.330]];
            L.polyline(macroCalzada, { color: '#3182CE', weight: 5, dashArray: '10, 5' }).addTo(leafletMap)
                .bindPopup('<h4>Mi Macro Calzada</h4><p>Calificación: 3.2 / 5</p>');

            // Ajustar el tamaño del mapa (bug común de Leaflet en pestañas)
            setTimeout(() => {
                leafletMap.invalidateSize();
            }, 100);
        }

        // --- LÓGICA DE GRÁFICAS ---
        function initAnalytics() {
            // Prevenir reinicialización
            if (ratingsChart) {
                return;
            }

            const ctx = document.getElementById('ratingsChart').getContext('2d');
            
            // Datos de demo para la gráfica
            const data = {
                labels: ratingCategories.map(cat => cat.name),
                datasets: [{
                    label: 'Calificación Promedio (de 5)',
                    data: [4.2, 3.1, 3.8, 4.5, 3.9, 2.8], // Datos ficticios
                    backgroundColor: [
                        'rgba(20, 184, 166, 0.6)',
                        'rgba(245, 158, 11, 0.6)',
                        'rgba(59, 130, 246, 0.6)',
                        'rgba(239, 68, 68, 0.6)',
                        'rgba(139, 92, 246, 0.6)',
                        'rgba(217, 70, 239, 0.6)'
                    ],
                    borderColor: [
                        'rgba(20, 184, 166, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(139, 92, 246, 1)',
                        'rgba(217, 70, 239, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8,
                }]
            };

            ratingsChart = new Chart(ctx, {
                type: 'bar', // Tipo de gráfica
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Hacerla horizontal
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 5, // El máximo es 5 estrellas
                            grid: {
                                display: true,
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#1f2937',
                            titleFont: {
                                family: "'Poppins', sans-serif",
                                weight: 'bold'
                            },
                            bodyFont: {
                                family: "'Poppins', sans-serif"
                            },
                            padding: 10,
                            cornerRadius: 8
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>
